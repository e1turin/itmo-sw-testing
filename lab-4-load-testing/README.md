# Лабораторная работа #4

С помощью программного пакета [Apache JMeter](https://jmeter.apache.org/)
провести нагрузочное и стресс-тестирование веб-приложения в соответствии с
вариантом задания.

В ходе нагрузочного тестирования необходимо протестировать 3 конфигурации
аппаратного обеспечения и выбрать среди них наиболее дешёвую, удовлетворяющую
требованиям по максимальному времени отклика приложения при заданной нагрузке
(в соответствии с вариантом).

В ходе стресс-тестирования необходимо определить, при какой нагрузке выбранная
на предыдущем шаге конфигурация перестаёт удовлетворять требованиями по
максимальному времени отклика. Для этого необходимо построить график
зависимости времени отклика приложения от нагрузки.

> Приложение для тестирования доступно только во внутренней сети кафедры.

> Если запрос содержит некорректные параметры, сервер возвращает HTTP 403.

> Если приложение не справляется с нагрузкой, сервер возвращает HTTP 503.

**Параметры тестируемого веб-приложения:**

- URL первой конфигурации ($ 3800) -
  http://stload.se.ifmo.ru:8080?token=492521201&user=2129818211&config=1;
- URL второй конфигурации ($ 4100) -
  http://stload.se.ifmo.ru:8080?token=492521201&user=2129818211&config=2;
- URL третьей конфигурации ($ 7200) -
  http://stload.se.ifmo.ru:8080?token=492521201&user=2129818211&config=3;
- Максимальное количество параллельных пользователей - 14;
- Средняя нагрузка, формируемая одним пользователем - 20 запр. в мин.;
- Максимально допустимое время обработки запроса - 690 мс.

**Отчёт по работе должен содержать:**

1. Текст задания.
2. Описание конфигурации JMeter для нагрузочного тестирования.
3. Графики пропускной способности приложения, полученные в ходе нагрузочного
   тестирования.
4. Выводы по выбранной конфигурации аппаратного обеспечения.
5. Описание конфигурации JMeter для стресс-тестирования.
6. График изменения времени отклика от нагрузки для выбранной конфигурации,
   полученный в ходе стресс-тестирования системы.
7. Выводы по работе.

**Вопросы к защите лабораторной работы:**

1. Тестирование системы целиком  - системное тестирование
2. Тестирование возможностей, стабильности, отказоустойчивости, совместимости
3. Тестирование производительности - CARAT
4. Альфа и Бета тестирование. Приемочное тестирование
5. Нагрузочное тестирование - виды, цели и решаемые задачи.
6. Принципы реализации нагрузочного тестирования ПО.
7. Инструменты для реализации нагрузочного тестирования.
8. Apache JMeter - архитектура, поддерживаемые протоколы, особенности
   конфигурации.
9. Стресс-тестирование - основные понятия, виды стресс-сценариев.
10. Стресс-тестирование ПО. Виды стресс-тестов ПО. Тестирование ёмкости.

- - -

# Комментарии по выполнению ЛР

Для получения доступа к серверу нужно использовать кафедральный VPN или 
пробросить порты через ssh:

```sh
ssh -N -L 8080:stload.se.ifmo.ru:8080 username@helios.se.ifmo.ru -p 2222
```
- `-N` – чтобы не запускать команду, только пробросить

JMeter скачал с сайта, распаковал в папку и запускается он 
- либо из консоли как `java -jar path/to/jmeter-dir/bin/ApacheJmeter.jar`,
- либо скриптом `jmeter.sh`, `jmeter.bat`, `jmeter` методом тыка (на него)
  или из консоли.

JMeter позволяет создавать конфиг для тестового плана из GUI, которые сохраняются
в виде XML в файлах `.jmx` (аля стандарт). Запускать же тестовые сценарии
рекомендуется из консоли, об этом пишут в консоли при запуске приложения:

```
================================================================================
Don't use GUI mode for load testing !, only for Test creation and Test debugging.
For load testing, use CLI Mode (was NON GUI):
   jmeter -n -t [jmx file] -l [results file] -e -o [Path to web report folder]
& increase Java Heap to meet your test requirements:
   Modify current env variable HEAP="-Xms1g -Xmx1g -XX:MaxMetaspaceSize=256m" in the jmeter batch file
Check : https://jmeter.apache.org/usermanual/best-practices.html
================================================================================
```

По всей видимости в JMeter может быть только один тестовый план – неприятное ограничение.

Чтобы было по красоте, добавлю описание ко всем элементам, попробую вынести
всё что можно в переменные. Спойлер – всё получилось! Продолжение смотри в источнике...
- https://jmeter.apache.org/usermanual/functions.html
- https://dev.to/adamleszko/guide-to-handling-variables-in-jmeter-3hkb

**Замечание 1.** JMeter ловит исключение при попытке записать файл с именем
содержащим `:`, т.к. NTFS не разрешает такие имена ¯\\_(ツ)_/¯. Для решения 
проблемы сохраню конфиг с более простым именем.
- Ошибки отмечаются в верхнем правом углу (желтый треугольный знак опасности)

В ноде тестового плана добавим ноду с "User Defined Variables", где определим
все интересующие нас переменные:

| Name | Value | Description |
| --- | --- | --- |
| `THREAD_GROUP_RUMPUP_PERIOD`    |	120	        | |
| `THREAD_GROUT_LOOP_COUNT`       |	20	        | |
| `MAX_NUM_PARALLEL_USERS`        |	14	        | "Максимальное количество параллельных пользователей" |
| `AVG_USER_LOAD_RPM`             |	20          | "Средняя нагрузка, формируемая одним пользователем" |
| `MAX_REQ_PROCESSING_TIME_MS`    |	690	        | "Максимально допустимое время обработки запроса" |
| `SERVER_NAME`                   |	localhost   | Порт проброшен на localhost |
| `SERVER_PORT`                   |	8080	    | Номер проброшенного порта |
| `GET_PARAM_TOKEN`               |	492521201	| Значение токена из GET-запроса |
| `GET_PARAM_USER`                |	2129818211	| Значение идентификатора пользователя из GET-запроса |

Так понимаю `TREAD_GROUP_RUMPUP_PERIOD` и `TREAD_GROUT_LOOP_COUNT` не задаются
по заданию и нужно придумать как их выбрать самому.

В каждой конфигурации Tread Group используется такой набор функциональных нод:

- HTTP Request (Thread Group > Add > Sampler) – отправка HTTP-запроса с
  параметрами на указаный URL (`GET_PARAM_TOKEN`, `GET_PARAM_USER`),
- Duration Assertion (Thread Group > Add > Assertionas) – ограничитель на время
  выполнения запроса (`MAX_REQ_PROCESSING_TIME_MS`),
- Constant Throughput Timer (Thread Group > Add > Timer) – ограничение
  количества запросов в минуту (`AVG_USER_LOAD_RPM`), рассчитанное для всех потоков в группе.

Для отладки конфигурации удобно добавить вывод результатов в таблицу и на график: 

- View Results in Table (Thread Group > Add > Listener),
- Graph Results (Thread Group > Add > Listener).

Осталось запустить нагрузочное тестирование из консоли:

```sh
jmeter.bat -n -t test-plan/LoadTestPlan.jmx -l load-test/results.log -e -o load-test/report
```

На этапе отладки конфигурации тестирования уже видно, что 1 и 2 конфигурации не
укладываются во временные ограничения `MAX_REQ_PROCESSING_TIME_MS` (у них
задержка порядка 700-1000 мс), в то время как 3 конфигурация отвечает довольно
живенько – 300 мс. Поэтому для дальнейшего стресс-тестирования предполагается
взять именно 3 конфигурацию.

В качестве стресс-нагрзки будет использоваться такая же конфигурация как и
ранее, но с большим числом параллельно работающих пользователей и дополнительным ограничением в виде

- Response Assertion (Thread Group > Add > Assertionas) – ограничитель на Response Cod равный 200.

Запустим стресс-тестироввание из консоли:

```sh
jmeter.bat -n -t test-plan/StressTestPlan.jmx -l stress-test/results.log -e -o stress-test/report
```

